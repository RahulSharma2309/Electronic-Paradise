name: Test Self-Hosted Runner

# This workflow tests if the self-hosted runner is working correctly
on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-runner.yml'

jobs:
  test-runner:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Runner Environment
        shell: pwsh
        run: |
          Write-Host "üß™ Testing Self-Hosted Runner Environment" -ForegroundColor Green
          Write-Host "========================================`n" -ForegroundColor Green
          
          # Test OS
          Write-Host "Operating System:" -ForegroundColor Cyan
          $os = Get-CimInstance Win32_OperatingSystem
          Write-Host "  Name: $($os.Caption)" -ForegroundColor Yellow
          Write-Host "  Version: $($os.Version)" -ForegroundColor Yellow
          Write-Host ""
          
          # Test Docker
          Write-Host "Docker:" -ForegroundColor Cyan
          try {
            $dockerVersion = docker --version
            Write-Host "  ‚úÖ $dockerVersion" -ForegroundColor Green
          } catch {
            Write-Host "  ‚ùå Docker not found" -ForegroundColor Red
          }
          Write-Host ""
          
          # Test kubectl
          Write-Host "kubectl:" -ForegroundColor Cyan
          try {
            $kubectlVersion = kubectl version --client --short 2>&1
            Write-Host "  ‚úÖ kubectl installed" -ForegroundColor Green
            Write-Host "  $kubectlVersion" -ForegroundColor Gray
          } catch {
            Write-Host "  ‚ùå kubectl not found" -ForegroundColor Red
          }
          Write-Host ""
          
          # Test Kubernetes context
          Write-Host "Kubernetes Context:" -ForegroundColor Cyan
          try {
            $context = kubectl config current-context
            Write-Host "  ‚úÖ Current context: $context" -ForegroundColor Green
            
            # Test cluster access
            $nodes = kubectl get nodes --no-headers 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "  ‚úÖ Can access Kubernetes cluster" -ForegroundColor Green
            } else {
              Write-Host "  ‚ö†Ô∏è Cannot access Kubernetes cluster" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "  ‚ùå kubectl not configured" -ForegroundColor Red
          }
          Write-Host ""
          
          # Test Git
          Write-Host "Git:" -ForegroundColor Cyan
          try {
            $gitVersion = git --version
            Write-Host "  ‚úÖ $gitVersion" -ForegroundColor Green
          } catch {
            Write-Host "  ‚ùå Git not found" -ForegroundColor Red
          }
          Write-Host ""
          
          # Test PowerShell
          Write-Host "PowerShell:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ Version: $($PSVersionTable.PSVersion)" -ForegroundColor Green
          Write-Host ""
          
          Write-Host "‚úÖ Runner environment test complete!" -ForegroundColor Green

      - name: Test kubectl Commands
        shell: pwsh
        run: |
          Write-Host "`nüîß Testing kubectl Commands" -ForegroundColor Green
          Write-Host "==========================`n" -ForegroundColor Green
          
          # Switch to docker-desktop context
          Write-Host "Switching to docker-desktop context..." -ForegroundColor Yellow
          kubectl config use-context docker-desktop
          
          # List namespaces
          Write-Host "`nNamespaces:" -ForegroundColor Cyan
          kubectl get namespaces
          
          # List nodes
          Write-Host "`nNodes:" -ForegroundColor Cyan
          kubectl get nodes
          
          Write-Host "`n‚úÖ kubectl commands working!" -ForegroundColor Green

      - name: Summary
        shell: pwsh
        run: |
          Write-Host "`nüìä Test Summary" -ForegroundColor Green
          Write-Host "===============" -ForegroundColor Green
          Write-Host "‚úÖ Self-hosted runner is working correctly!" -ForegroundColor Green
          Write-Host "‚úÖ Ready to run CD pipeline" -ForegroundColor Green
